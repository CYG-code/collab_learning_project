<!DOCTYPE html>
<html>
<head>
    <title>AI åä½œå­¦ä¹ å®¤</title>
    <meta charset="utf-8">
    <script src="https://cdn.bootcdn.net/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        #chat-container { width: 100%; max-width: 900px; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 90vh; position: relative; transition: all 0.3s;}
        
        /* æ‹–æ‹½æ—¶çš„å…¨å±€è’™ç‰ˆæ•ˆæœ */
        .drag-active { outline: 4px dashed #3498db !important; outline-offset: -10px; background: rgba(52, 152, 219, 0.05) !important; }
        
        #header { padding: 15px 20px; background: #2c3e50; color: white; border-radius: 12px 12px 0 0; font-weight: bold; font-size: 1.2em; display: flex; justify-content: space-between; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .msg-box { max-width: 85%; padding: 12px 18px; border-radius: 8px; line-height: 1.6; font-size: 0.95em; }
        .msg-sender { font-size: 0.85em; font-weight: bold; margin-bottom: 8px; color: #555; }
        .msg-Human { background: #dcf8c6; align-self: flex-end; }
        .msg-Planner { background: #f8f9fa; align-self: flex-start; border-left: 4px solid #3498db; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .msg-Facilitator { background: #fffdf7; align-self: flex-start; border-left: 4px solid #f39c12; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .msg-System { background: transparent; align-self: center; font-size: 0.8em; color: #aaa; text-align: center; }
        
        /* ä»£ç å— UI æ ·å¼ */
        .code-block-wrapper { background: #0d1117; border-radius: 8px; margin: 15px 0; overflow: hidden; border: 1px solid #30363d;}
        .code-header { display: flex; justify-content: space-between; align-items: center; background: #161b22; padding: 8px 15px; color: #8b949e; font-size: 0.85em; border-bottom: 1px solid #30363d; }
        .code-lang { font-weight: 600; }
        .code-copy-btn { background: none; border: none; color: #8b949e; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.9em; padding: 0; }
        .code-copy-btn:hover { color: #c9d1d9; }
        .markdown-body pre { margin: 0 !important; padding: 15px !important; background: transparent !important; color: #c9d1d9; overflow-x: auto; }
        .markdown-body pre code { font-family: 'Consolas', monospace; font-size: 0.9em; }
        .markdown-body :not(pre) > code { background: rgba(0,0,0,0.06); color: #d63384; padding: 3px 6px; border-radius: 4px; font-family: monospace; font-size: 0.9em;}
        .markdown-body p { margin-top: 0; margin-bottom: 10px; }
        .markdown-body p:last-child { margin-bottom: 0; }
        
        #typing-indicator { padding: 5px 20px; font-size: 0.85em; color: #888; font-style: italic; min-height: 20px; }
        
        /* é™„ä»¶é¢„è§ˆåŒºåŸŸ */
        #attachment-preview { display: none; padding: 10px 20px; background: #f8f9fa; border-top: 1px solid #eee; gap: 10px; flex-wrap: wrap; }
        .file-chip { display: flex; align-items: center; background: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85em; color: #2c3e50; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.02);}
        .file-chip img { max-height: 20px; margin-right: 8px; border-radius: 3px; }
        .remove-file { margin-left: 10px; cursor: pointer; color: #e74c3c; font-weight: bold; }
        
        #input-area { display: flex; padding: 15px; border-top: 1px solid #eee; background: #fafafa; border-radius: 0 0 12px 12px; align-items: center; gap: 10px;}
        #btn-attach { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #7f8c8d; }
        #btn-attach:hover { color: #2c3e50; }
        #messageText { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; font-size: 1em; }
        #messageText:focus { border-color: #3498db; }
        #btn-send { padding: 12px 25px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;}
        #btn-send:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="header">
            <span>ğŸš€ å¤šæ™ºèƒ½ä½“åä½œå­¦ä¹ ç©ºé—´</span>
            <span id="user-display">æœªè¿æ¥</span>
        </div>
        <div id="messages"></div>
        <div id="typing-indicator"></div>
        
        <div id="attachment-preview"></div>
        
        <div id="input-area">
            <input type="file" id="fileInput" style="display: none;" multiple accept=".pdf,image/*">
            <button id="btn-attach" onclick="document.getElementById('fileInput').click()" title="ä¸Šä¼ æ–‡æ¡£/å›¾ç‰‡ (æ”¯æŒæ‹–æ‹½å’Œç²˜è´´)">ğŸ“</button>
            <input type="text" id="messageText" autocomplete="off" placeholder="è¾“å…¥æ–‡å­—ï¼Œæˆ–ç›´æ¥ç²˜è´´å›¾ç‰‡/æ‹–æ‹½æ–‡ä»¶è¿›çª—å£..."/>
            <button id="btn-send" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <script>
        // let username = prompt("è¯·è¾“å…¥ä½ çš„åä½œå (å¦‚ï¼šå­¦ç”ŸA)ï¼š") || "åŒ¿åè€…" + Math.floor(Math.random()*1000);
        // test
        let username = "æµ‹è¯•åŒå­¦A";

        document.getElementById("user-display").innerText = "èº«ä»½: " + username;

        let ws = new WebSocket(`ws://localhost:8000/ws/${username}`);
        let typingUsers = new Set();
        let aiTimerInterval = null;
        let aiStartTime = 0;
        
        // ä¸“é—¨å­˜æ”¾ç­‰å¾…å‘é€çš„æ–‡ä»¶å®¹å™¨
        let pendingFiles = [];

        const renderer = {
            code(token) {
                const codeText = token.text || '';
                const lang = token.lang || 'plaintext';
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                const highlighted = hljs.highlight(codeText, { language }).value;
                const safeCode = btoa(unescape(encodeURIComponent(codeText)));

                return `
                <div class="code-block-wrapper">
                    <div class="code-header">
                        <span class="code-lang">${language.toUpperCase()}</span>
                        <button class="code-copy-btn" onclick="copyCode(this, '${safeCode}')">
                            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            <span>å¤åˆ¶ä»£ç </span>
                        </button>
                    </div>
                    <pre><code class="hljs language-${language}">${highlighted}</code></pre>
                </div>`;
            }
        };

        marked.use({ breaks: true, renderer: renderer });

        ws.onmessage = function(event) {
            let data = JSON.parse(event.data);
            if (data.type === "message") renderMessage(data);
            else if (data.type === "typing") updateTypingIndicator(data);
        };

        function renderMessage(data) {
            let messages = document.getElementById('messages');
            let msgDiv = document.createElement('div');
            
            let roleClass = "msg-System";
            if (data.sender === username || (!["Planner", "Facilitator", "System"].includes(data.sender))) {
                roleClass = "msg-Human";
            } else if (data.sender === "Planner") roleClass = "msg-Planner";
            else if (data.sender === "Facilitator") roleClass = "msg-Facilitator";

            msgDiv.className = `msg-box ${roleClass}`;
            
            if (data.sender === "System") {
                msgDiv.innerText = data.message;
            } else {
                let safeMessage = String(data.message || '');
                let parsedHTML = marked.parse(safeMessage);
                msgDiv.innerHTML = `<div class="msg-sender">${data.sender}</div><div class="markdown-body">${parsedHTML}</div>`;
            }

            messages.appendChild(msgDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function updateTypingIndicator(data) {
            if (data.is_typing && data.sender !== username) {
                typingUsers.add(data.sender);
                if (["Planner", "Facilitator"].includes(data.sender) && !aiTimerInterval) {
                    aiStartTime = Date.now();
                    aiTimerInterval = setInterval(renderTypingText, 1000); 
                }
            } else {
                typingUsers.delete(data.sender);
                let hasAIThinking = Array.from(typingUsers).some(u => ["Planner", "Facilitator"].includes(u));
                if (!hasAIThinking && aiTimerInterval) {
                    clearInterval(aiTimerInterval);
                    aiTimerInterval = null;
                }
            }
            renderTypingText();
        }

        function renderTypingText() {
            let indicatorDiv = document.getElementById("typing-indicator");
            if (typingUsers.size === 0) { indicatorDiv.innerText = ""; return; }

            let users = Array.from(typingUsers);
            let aiUsers = users.filter(u => ["Planner", "Facilitator"].includes(u));
            let humanUsers = users.filter(u => !["Planner", "Facilitator"].includes(u));

            let parts = [];
            if (aiUsers.length > 0) {
                let elapsedSeconds = Math.floor((Date.now() - aiStartTime) / 1000);
                parts.push(`ğŸ§  ${aiUsers.join(", ")} æ­£åœ¨æ€è€ƒ... (${elapsedSeconds}s)`);
            }
            if (humanUsers.length > 0) parts.push(`âŒ¨ï¸ ${humanUsers.join(", ")} æ­£åœ¨è¾“å…¥...`);
            indicatorDiv.innerText = parts.join("  |  ");
        }

        let typingTimeout;
        document.getElementById("messageText").addEventListener("input", function() {
            ws.send(JSON.stringify({type: "typing", is_typing: true}));
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => { ws.send(JSON.stringify({type: "typing", is_typing: false})); }, 1000);
        });

        // ==========================================
        // æ ¸å¿ƒåŠŸèƒ½ï¼šæ–‡ä»¶å¤„ç†æ¨¡å— (æ‹–æ‹½ã€ç²˜è´´ã€é€‰æ‹©)
        // ==========================================
        
        // 1. æ‹–æ‹½ç›‘å¬
        const chatContainer = document.getElementById("chat-container");
        chatContainer.addEventListener("dragover", (e) => {
            e.preventDefault();
            chatContainer.classList.add("drag-active");
        });
        chatContainer.addEventListener("dragleave", () => {
            chatContainer.classList.remove("drag-active");
        });
        chatContainer.addEventListener("drop", (e) => {
            e.preventDefault();
            chatContainer.classList.remove("drag-active");
            handleFiles(e.dataTransfer.files);
        });

        // 2. ç²˜è´´æ‹¦æˆª (æ”¯æŒå¾®ä¿¡æˆªå›¾ç›´æ¥ Ctrl+V)
        document.getElementById("messageText").addEventListener("paste", (e) => {
            if (e.clipboardData.files.length > 0) {
                e.preventDefault(); 
                handleFiles(e.clipboardData.files);
            }
        });

        // 3. æŒ‰é’®é€‰æ‹©æ–‡ä»¶
        document.getElementById("fileInput").addEventListener("change", (e) => {
            handleFiles(e.target.files);
            e.target.value = ""; // æ¸…ç©ºï¼Œå…è®¸é‡å¤é€‰æ‹©åŒåæ–‡ä»¶
        });

        // è§£æå¹¶å±•ç¤ºé¢„è§ˆ
        function handleFiles(files) {
            for (let f of files) {
                if (!f.type.match("image.*") && f.type !== "application/pdf") {
                    alert("ç›®å‰ä»…æ”¯æŒå›¾ç‰‡å’Œ PDF æ ¼å¼ï¼");
                    continue;
                }
                
                let reader = new FileReader();
                reader.onload = function(e) {
                    pendingFiles.push({ name: f.name, mime: f.type, data: e.target.result });
                    renderFilePreviews();
                };
                reader.readAsDataURL(f);
            }
        }

        function renderFilePreviews() {
            const container = document.getElementById("attachment-preview");
            container.innerHTML = "";
            
            if (pendingFiles.length === 0) {
                container.style.display = "none";
                return;
            }
            
            container.style.display = "flex";
            pendingFiles.forEach((f, index) => {
                let chip = document.createElement("div");
                chip.className = "file-chip";
                let icon = f.mime.startsWith("image/") ? `<img src="${f.data}">` : `ğŸ“„ `;
                chip.innerHTML = `${icon} <span>${f.name}</span> <span class="remove-file" onclick="removeFile(${index})">âœ–</span>`;
                container.appendChild(chip);
            });
        }

        function removeFile(index) {
            pendingFiles.splice(index, 1);
            renderFilePreviews();
        }

        function sendMessage() {
            let input = document.getElementById("messageText");
            let content = input.value.trim();
            
            if (content === "" && pendingFiles.length === 0) return;

            // æ‰“åŒ…æ–‡æœ¬å’Œ Base64 æ–‡ä»¶ç»„ä¸€èµ·å‘é€
            ws.send(JSON.stringify({
                type: "message", 
                content: content || "è¯·æŸ¥çœ‹é™„å¸¦çš„æ–‡ä»¶ã€‚", 
                files: pendingFiles 
            }));
            
            input.value = '';
            ws.send(JSON.stringify({type: "typing", is_typing: false}));
            
            // æ¸…ç©ºæ–‡ä»¶é˜Ÿåˆ—
            pendingFiles = [];
            renderFilePreviews();
        }

        document.getElementById("messageText").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });

        function copyCode(btn, base64Code) {
            const rawCode = decodeURIComponent(escape(atob(base64Code)));
            navigator.clipboard.writeText(rawCode).then(() => {
                const span = btn.querySelector('span');
                const originalText = span.innerText;
                span.innerText = 'âœ… å·²å¤åˆ¶';
                setTimeout(() => { span.innerText = originalText; }, 2000);
            }).catch(err => console.error('å¤åˆ¶å¤±è´¥!', err));
        }
    </script>
</body>
</html>