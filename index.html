<!DOCTYPE html>
<html>
<head>
    <title>AI åä½œå­¦ä¹ å®¤</title>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        #chat-container { width: 100%; max-width: 900px; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 90vh; }
        #header { padding: 15px 20px; background: #2c3e50; color: white; border-radius: 12px 12px 0 0; font-weight: bold; font-size: 1.2em; display: flex; justify-content: space-between; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        /* æ°”æ³¡æ ·å¼é‡æ„ */
        .msg-box { max-width: 85%; padding: 12px 18px; border-radius: 8px; line-height: 1.6; font-size: 0.95em; }
        .msg-sender { font-size: 0.85em; font-weight: bold; margin-bottom: 8px; color: #555; }
        .msg-Human { background: #dcf8c6; align-self: flex-end; }
        .msg-Planner { background: #f8f9fa; align-self: flex-start; border-left: 4px solid #3498db; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .msg-Facilitator { background: #fffdf7; align-self: flex-start; border-left: 4px solid #f39c12; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .msg-System { background: transparent; align-self: center; font-size: 0.8em; color: #aaa; text-align: center; }
        
        /* ==================================== */
        /* å·¥ä¸šçº§ä»£ç å— UI (å¸¦å¤´éƒ¨æ ä¸å¤åˆ¶æŒ‰é’®) */
        /* ==================================== */
        
        .code-block-wrapper {
            background: #0d1117; /* æå®¢é»‘åº•è‰² */
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden; /* è®©å­å…ƒç´ ä¸æº¢å‡ºåœ†è§’ */
            border: 1px solid #30363d;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #161b22; /* å¤´éƒ¨æ ç¨å¾®äº®ä¸€ç‚¹ç‚¹ï¼Œå½¢æˆå±‚æ¬¡æ„Ÿ */
            padding: 8px 15px;
            color: #8b949e;
            font-size: 0.85em;
            font-family: 'Segoe UI', sans-serif;
            border-bottom: 1px solid #30363d;
        }

        .code-lang {
            font-weight: 600;
            text-transform: uppercase;
        }

        .code-copy-btn {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            padding: 0;
            transition: color 0.2s;
        }

        .code-copy-btn:hover {
            color: #c9d1d9;
        }

        /* é‡å†™ preï¼Œå»æ‰è‡ªå¸¦çš„èƒŒæ™¯å’Œè¾¹è·ï¼Œè®©å®ƒå®Œç¾èå…¥ wrapper */
        .markdown-body pre { 
            margin: 0 !important; 
            padding: 15px !important; 
            background: transparent !important; 
            border-radius: 0 !important; 
            overflow-x: auto;
            color: #c9d1d9;
        }
        
        .markdown-body pre code { 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 0.9em;
        }
        
        /* æ®µè½ä¸é—´è·ä¼˜åŒ– */
        .markdown-body p { margin-top: 0; margin-bottom: 10px; }
        .markdown-body p:last-child { margin-bottom: 0; }
        
        /* çŠ¶æ€æ„ŸçŸ¥æ  */
        #typing-indicator { padding: 5px 20px; font-size: 0.85em; color: #888; font-style: italic; min-height: 20px; }
        
        /* è¾“å…¥åŒº */
        #input-area { display: flex; padding: 15px; border-top: 1px solid #eee; background: #fafafa; border-radius: 0 0 12px 12px; align-items: center; gap: 10px;}
        #btn-attach { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #7f8c8d; }
        #btn-attach:hover { color: #2c3e50; }
        #messageText { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; font-size: 1em; }
        #messageText:focus { border-color: #3498db; }
        #btn-send { padding: 12px 25px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s;}
        #btn-send:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="header">
            <span>ğŸš€ å¤šæ™ºèƒ½ä½“åä½œå­¦ä¹ ç©ºé—´</span>
            <span id="user-display">æœªè¿æ¥</span>
        </div>
        <div id="messages"></div>
        
        <div id="typing-indicator"></div>
        
        <div id="input-area">
            <input type="file" id="fileInput" style="display: none;" multiple accept=".txt,.pdf,image/*">
            <button id="btn-attach" onclick="document.getElementById('fileInput').click()" title="ä¸Šä¼ æ–‡æ¡£/å›¾ç‰‡">ğŸ“</button>
            
            <input type="text" id="messageText" autocomplete="off" placeholder="æ¢è®¨é—®é¢˜ï¼Œæˆ–è¾“å…¥ @Planner æé—®..."/>
            <button id="btn-send" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <script>
        let username = prompt("è¯·è¾“å…¥ä½ çš„åä½œå (å¦‚ï¼šå­¦ç”ŸA)ï¼š") || "åŒ¿åè€…" + Math.floor(Math.random()*1000);
        document.getElementById("user-display").innerText = "èº«ä»½: " + username;

        let ws = new WebSocket(`ws://localhost:8000/ws/${username}`);
        let typingUsers = new Set(); // å­˜å‚¨å½“å‰æ­£åœ¨è¾“å…¥çš„äºº/AI

        // ==========================================
        // 1. å®‰å…¨ Markdown æ¸²æŸ“å™¨é…ç½®
        // ==========================================
        const renderer = {
            code(token) {
                const codeText = token.text || '';
                const lang = token.lang || 'plaintext';
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                const highlighted = hljs.highlight(codeText, { language }).value;
                const safeCode = btoa(unescape(encodeURIComponent(codeText)));

                return `
                <div class="code-block-wrapper">
                    <div class="code-header">
                        <span class="code-lang">${language.toUpperCase()}</span>
                        <button class="code-copy-btn" onclick="copyCode(this, '${safeCode}')">
                            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            <span>å¤åˆ¶ä»£ç </span>
                        </button>
                    </div>
                    <pre><code class="hljs language-${language}">${highlighted}</code></pre>
                </div>`;
            }
        };

        marked.use({ 
            breaks: true,
            renderer: renderer 
        });

        // å‰ªè´´æ¿å¤åˆ¶è§¦å‘å‡½æ•°
        function copyCode(btn, base64Code) {
            const rawCode = decodeURIComponent(escape(atob(base64Code)));
            navigator.clipboard.writeText(rawCode).then(() => {
                const span = btn.querySelector('span');
                const originalText = span.innerText;
                span.innerText = 'âœ… å·²å¤åˆ¶';
                setTimeout(() => { span.innerText = originalText; }, 2000);
            }).catch(err => console.error('å¤åˆ¶å¤±è´¥!', err));
        }

        // ==========================================
        // 2. æ¶ˆæ¯æ¥æ”¶ä¸æ¸²æŸ“
        // ==========================================
        ws.onmessage = function(event) {
            let data = JSON.parse(event.data);
            
            if (data.type === "message") {
                renderMessage(data);
            } else if (data.type === "typing") {
                updateTypingIndicator(data);
            }
        };

        function renderMessage(data) {
            let messages = document.getElementById('messages');
            let msgDiv = document.createElement('div');
            
            let roleClass = "msg-System";
            if (data.sender === username || (!["Planner", "Facilitator", "System"].includes(data.sender))) {
                roleClass = "msg-Human";
            } else if (data.sender === "Planner") {
                roleClass = "msg-Planner";
            } else if (data.sender === "Facilitator") {
                roleClass = "msg-Facilitator";
            }

            msgDiv.className = `msg-box ${roleClass}`;
            
            if (data.sender === "System") {
                msgDiv.innerText = data.message;
            } else {
                // ğŸ›¡ï¸ æ ¸å¿ƒä¿®å¤ç‚¹ï¼šå¼ºåˆ¶è½¬æ¢ä¸º Stringï¼Œå…œåº• undefinedï¼Œé˜²æ­¢ markedjs å´©æºƒ
                let safeMessage = String(data.message || '');
                let parsedHTML = marked.parse(safeMessage);
                
                msgDiv.innerHTML = `<div class="msg-sender">${data.sender}</div><div class="markdown-body">${parsedHTML}</div>`;
            }

            messages.appendChild(msgDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // ==========================================
        // 3. åä½œæ„ŸçŸ¥ä¸ AI æ€è€ƒè®¡æ—¶å™¨
        // ==========================================
        
        let aiTimerInterval = null;
        let aiStartTime = 0;

        function updateTypingIndicator(data) {
            if (data.is_typing && data.sender !== username) {
                typingUsers.add(data.sender);
                
                if (["Planner", "Facilitator"].includes(data.sender) && !aiTimerInterval) {
                    aiStartTime = Date.now();
                    // é¢‘ç‡é™ä½ï¼šæ¯ 1000 æ¯«ç§’ï¼ˆ1ç§’ï¼‰åˆ·æ–°ä¸€æ¬¡ UI å³å¯
                    aiTimerInterval = setInterval(renderTypingText, 1000); 
                }
            } else {
                typingUsers.delete(data.sender);
                
                let hasAIThinking = Array.from(typingUsers).some(u => ["Planner", "Facilitator"].includes(u));
                if (!hasAIThinking && aiTimerInterval) {
                    clearInterval(aiTimerInterval);
                    aiTimerInterval = null;
                }
            }
            
            renderTypingText();
        }

        function renderTypingText() {
            let indicatorDiv = document.getElementById("typing-indicator");
            if (typingUsers.size === 0) {
                indicatorDiv.innerText = "";
                return;
            }

            let users = Array.from(typingUsers);
            let aiUsers = users.filter(u => ["Planner", "Facilitator"].includes(u));
            let humanUsers = users.filter(u => !["Planner", "Facilitator"].includes(u));

            let parts = [];
            
            if (aiUsers.length > 0) {
                // ä½¿ç”¨ Math.floor å‘ä¸‹å–æ•´ï¼Œè·å–çº¯ç²¹çš„ç§’æ•°
                let elapsedSeconds = Math.floor((Date.now() - aiStartTime) / 1000);
                // æ ¼å¼ä¿®æ”¹ï¼šåŠ äº†æ‹¬å·
                parts.push(`ğŸ§  ${aiUsers.join(", ")} æ­£åœ¨æ€è€ƒ... (${elapsedSeconds}s)`);
            }
            
            if (humanUsers.length > 0) {
                parts.push(`âŒ¨ï¸ ${humanUsers.join(", ")} æ­£åœ¨è¾“å…¥...`);
            }

            indicatorDiv.innerText = parts.join("  |  ");
        }

        let typingTimeout;
        document.getElementById("messageText").addEventListener("input", function() {
            ws.send(JSON.stringify({type: "typing", is_typing: true}));
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                ws.send(JSON.stringify({type: "typing", is_typing: false}));
            }, 1000);
        });

        function sendMessage() {
            let input = document.getElementById("messageText");
            if (input.value.trim() !== "") {
                ws.send(JSON.stringify({type: "message", content: input.value}));
                input.value = '';
                ws.send(JSON.stringify({type: "typing", is_typing: false}));
            }
        }

        document.getElementById("messageText").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });
        
        // é¢„ç•™çš„é™„ä»¶ä¸Šä¼ ç›‘å¬å™¨
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if(e.target.files.length > 0) {
                alert("æ–‡ä»¶ [" + e.target.files[0].name + "] å·²é€‰ä¸­ï¼(åç«¯å¤šæ¨¡æ€è§£æé€»è¾‘å¾…æ¥å…¥)");
            }
        });
    </script>
</body>
</html>